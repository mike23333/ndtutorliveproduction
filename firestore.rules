rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection - users can read/write their own document
    // Teachers can also read their students' documents
    match /users/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        // Teachers can read their assigned students
        (resource.data.teacherId == request.auth.uid && resource.data.role == 'student') ||
        // Anyone can read teacher docs to validate class codes (only exposes classCode, displayName)
        resource.data.role == 'teacher'
      );
      allow write: if request.auth != null && (
        request.auth.uid == userId ||
        // Teachers can update their students (for removing from class)
        (resource.data.teacherId == request.auth.uid && resource.data.role == 'student')
      );

      // User profile subcollection
      match /profile/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User struggles subcollection (DEPRECATED - use reviewItems)
      match /struggles/{struggleId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User review items subcollection (for tracking errors and weekly reviews)
      match /reviewItems/{reviewItemId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User session summaries (for progress tracking)
      match /sessionSummaries/{summaryId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User review lessons (weekly generated reviews)
      match /reviewLessons/{reviewId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User custom lessons (student-created practice lessons)
      match /customLessons/{lessonId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User sessions (token usage tracking)
      match /sessions/{sessionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User badges subcollection
      // Users can read their own badges, but only backend can write (badges are awarded by system)
      match /badges/{badgeId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        // Write is allowed since badges are awarded through client-side transactions
        // In production with a backend, change this to: allow write: if false;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Missions collection - tenant isolation
    // Teachers can manage their own missions
    // Students can only read missions from their assigned teacher
    match /missions/{missionId} {
      allow read: if request.auth != null && (
        // Teachers/admins can read their own missions
        resource.data.teacherId == request.auth.uid ||
        // Students can read missions from their assigned teacher
        resource.data.teacherId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teacherId
      );
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null
        && resource.data.teacherId == request.auth.uid;
    }

    // Sessions collection - users can manage their own sessions
    match /sessions/{sessionId} {
      allow read, write: if request.auth != null;

      // Struggles subcollection
      match /struggles/{struggleId} {
        allow read, write: if request.auth != null;
      }
    }

    // Prompt Templates - private per teacher
    match /promptTemplates/{templateId} {
      allow read: if request.auth != null
        && resource.data.teacherId == request.auth.uid;
      allow create: if request.auth != null
        && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if request.auth != null
        && resource.data.teacherId == request.auth.uid;
    }

    // System Templates - editable by teachers/admins, readable by backend
    // Note: Backend uses admin SDK which bypasses these rules
    match /systemTemplates/{templateId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
      // In production, you may want to restrict write to admin role:
      // allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['teacher', 'admin'];
    }

    // Groups collection - DEPRECATED (using direct teacherId on students instead)
    // Kept for backwards compatibility but not actively used
    match /groups/{groupId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null
        && resource.data.teacherId == request.auth.uid;
    }

    // Analytics collection
    match /analytics/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Token Usage (session token tracking)
    match /tokenUsage/{sessionId} {
      allow read, write: if request.auth != null;
    }

    // User Token Aggregates (usage statistics)
    match /userTokenAggregates/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Session Summaries
    match /sessionSummaries/{summaryId} {
      allow read, write: if request.auth != null;
    }

    // Badge Definitions - read-only for all authenticated users
    // These define the badge metadata and criteria
    match /badgeDefinitions/{badgeId} {
      allow read: if request.auth != null;
      // Only admin can write badge definitions
      allow write: if false;
    }

    // Private Student Codes - for 1:1 private tutoring
    // Teachers can manage their own codes, anyone can read to validate during onboarding
    match /privateStudentCodes/{codeId} {
      // Anyone authenticated can read codes (needed for validation during student join)
      allow read: if request.auth != null;
      // Only teachers can create codes (must set themselves as teacherId)
      allow create: if request.auth != null
        && request.resource.data.teacherId == request.auth.uid;
      // Teachers can update/delete their own codes
      // Students can update ONLY to mark as used (when code is active)
      allow update: if request.auth != null && (
        // Teacher can update their own codes
        resource.data.teacherId == request.auth.uid ||
        // Student can mark an active code as used (setting themselves as the user)
        (resource.data.status == 'active' &&
         request.resource.data.status == 'used' &&
         request.resource.data.usedByStudentId == request.auth.uid)
      );
      // Only the owning teacher can delete codes
      allow delete: if request.auth != null
        && resource.data.teacherId == request.auth.uid;
    }
  }
}
