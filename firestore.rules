rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection - users can read/write their own document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // User profile subcollection
      match /profile/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User struggles subcollection (for review lessons)
      match /struggles/{struggleId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User session summaries (for progress tracking)
      match /sessionSummaries/{summaryId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User review lessons (weekly generated reviews)
      match /reviewLessons/{reviewId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Missions collection - teachers can manage their own missions
    match /missions/{missionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null
        && resource.data.teacherId == request.auth.uid;
    }

    // Sessions collection - users can manage their own sessions
    match /sessions/{sessionId} {
      allow read, write: if request.auth != null;

      // Struggles subcollection
      match /struggles/{struggleId} {
        allow read, write: if request.auth != null;
      }
    }

    // Prompt Templates - private per teacher
    match /promptTemplates/{templateId} {
      allow read: if request.auth != null
        && resource.data.teacherId == request.auth.uid;
      allow create: if request.auth != null
        && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if request.auth != null
        && resource.data.teacherId == request.auth.uid;
    }

    // System Templates - editable by teachers/admins, readable by backend
    // Note: Backend uses admin SDK which bypasses these rules
    match /systemTemplates/{templateId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
      // In production, you may want to restrict write to admin role:
      // allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['teacher', 'admin'];
    }

    // Groups collection
    match /groups/{groupId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null
        && resource.data.teacherId == request.auth.uid;
    }

    // Analytics collection
    match /analytics/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Token Usage (session token tracking)
    match /tokenUsage/{sessionId} {
      allow read, write: if request.auth != null;
    }

    // User Token Aggregates (usage statistics)
    match /userTokenAggregates/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Session Summaries
    match /sessionSummaries/{summaryId} {
      allow read, write: if request.auth != null;
    }
  }
}
